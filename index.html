<!DOCTYPE html>
<html moznomarginboxes mozdisallowselectionprint>
    <head>
        <title>Seat Change</title>
        <meta charset="utf-8">
        <meta name="description" content="席替えソフト">
    </head>
    <body>
        <div class="noPrint control">
            <div>
                <h1>席替え</h1>
            </div>
            <div>
                <button onclick="showpolicy()">方針</button>
            </div>
            <div>
                <table id="prop">
                    <tr>
                        <td>席の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>人の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>前列席の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>前列希望の人の数</td>
                        <td>0</td>
                    </tr>
                </table>
            </div>
            <progress id="step" max="5" value="1"></progress>
            <div id="step1">
                <p>タイトルを定義</p>
                <input id="deftitle" type="text" onchange="changetitle()" onkeyup="changetitle()" value="○月の席">
            </div>
            <div id="step2">
                <p>席の定義</p>
                <table>
                    <tr>
                        <td>行</td>
                        <td><input id="line" type="number" onchange="changeseat()" value="6"></td>
                    </tr>
                    <tr>
                        <td>列</td>
                        <td><input id="row" type="number" onchange="changeseat()" value="6"></td>
                    </tr>
                </table>
            </div>
            <div id="step3">
                <p>前列席の定義</p>
                <button onclick="addfrontseat()">欄を追加</button>
                <table id="frontseat">
                </table>
            </div>
            <div id="step4">
                <p>人を追加</p>
                <button onclick="addperson()">欄を追加</button>
                <table>
                    <thead>
                        <tr>
                            <td>出席番号</td>
                            <td>名前</td>
                            <td>前列</td>
                            <td>削除</td>
                        </tr>
                    </thead>
                    <tbody id="people">
                    </tbody>
                </table>
            </div>
            <div id="step5">
                <button onclick="makeseat()">生成</button>
            </div>
            <div id="step6">
                <button onclick="print()">print</button>
            </div>
            <div id="policy" style="visibility: hidden;">
                <button onclick="closepolicy()" id="closepolicy">閉じる</button>
                <div id="contents"></div>
            </div>
        </div>
        <center>
            <div class="rareaframe">
                <div class="rarea">
                    <h1 class="title" id="title"></h1>
                    <p class="front">前</p>
                    <div class="rresize">
                        <table id="result"></table>
                    </div>
                </div>
            </div>
        </center>
    </body>
</html>
<script>
    var pcnt=0;
    var member = [];
    var line,row;
    var seat = [];

    function addfrontseat() {
        let tr = document.createElement("tr");
        let td1 = document.createElement("td");
        let ix = document.createElement("input");
        ix.type = "number";
        ix.placeholder = "number";
        ix.value = pcnt.toString();
        ix.onchange = function() {showprop();};
        td1.appendChild(ix);
        tr.appendChild(td1);
        let td2 = document.createElement("td");
        let iy = document.createElement("input");
        iy.type = "number";
        iy.placeholder = "number";
        iy.value = pcnt.toString();
        iy.onchange = function() {showprop();};
        td1.appendChild(iy);
        tr.appendChild(td1);
        let td3 = document.createElement("td");
        let del = document.createElement("input");
        del.onclick = function(e){e.explicitOriginalTarget.parentNode.parentNode.remove();showprop();};
        del.type = "button";
        del.value = "x"
        td3.appendChild(del);
        tr.appendChild(td3);
        document.getElementById("frontseat").appendChild(tr);
    }
    function addperson() {
        pcnt++;
        let tr = document.createElement("tr")
        let td1 = document.createElement("td");
        let iid = document.createElement("input");
        iid.type = "number";
        iid.placeholder = "number";
        iid.value = pcnt.toString();
        td1.appendChild(iid);
        tr.appendChild(td1);
        let td2 = document.createElement("td");
        let iarea = document.createElement("input");
        iarea.type = "text";
        iarea.placeholder = "name";
        td2.appendChild(iarea);
        tr.appendChild(td2);
        let td3 = document.createElement("td");
        let check = document.createElement("input");
        check.type = "checkbox";
        check.onchange = function() {showprop();};
        td3.appendChild(check);
        tr.appendChild(td3);
        let td4 = document.createElement("td");
        let del = document.createElement("input");
        del.onclick = function(e){e.explicitOriginalTarget.parentNode.parentNode.remove();showprop();};
        del.type = "button";
        del.value = "x"
        td4.appendChild(del);
        tr.appendChild(td4);
        document.getElementById("people").appendChild(tr);
        showprop();
    }

    function showprop() {
        prop = document.getElementById("prop").querySelectorAll("td")
        let table = document.getElementById("result").querySelectorAll("td");
        let people = document.getElementById("people").querySelectorAll("tr");
        let front = 0;
        let fronts = 0
        for (let c=0;c<people.length;c++) {
            if (people[c].querySelectorAll("input")[2].checked) {
                front++;
            }
        }
        for (let ys=0;ys<row;ys++) {
            for (let xs=0;xs<line;xs++) {
                if (seat[ys*row+xs]==1) {
                    if (table[ys*line+xs]!=null) {
                        table[ys*line+xs].className = "seat frontseat"
                    }
                    fronts++;
                }
                else {
                    if (table[ys*line+xs]!=null) {
                        table[ys*line+xs].className = "seat"
                    }
                }
            }
        }
        prop[1].innerHTML = row*line;
        prop[3].innerHTML = people.length;
        prop[5].innerHTML = fronts;
        prop[7].innerHTML = front;
    }

    
    function defseating() {
        seat = Array(row*line).fill(0);
        let fseatn = 2
        let rseatn = 2
        let otseatn = 5
        fmember = [["1","太郎"],["2","花子"]]
        rmember = [["3","次郎"],["4","三郎"]]
        fseat = Array(fseatn).fill([0,"空席",3])
        rseat = Array(rseatn).fill([0,"空席",3])
        fseatplace = [7,2]
        rseatplace = [4,5]
        let seating = Array(row*line).fill([0,"空席",3]);
        { // f member
            for (let m=0;m<fmember.length;m++) {
                let a=0;
                while (true) {
                    a = Math.floor(Math.random()*fseatn);
                    if (fseat[a][2]==3) break;
                }
                if (fmember[m][1].length>0) {
                    fseat[a] = [fmember[m][0],fmember[m][1],0];
                }
                else {
                    fseat[a] = [0,"名無し",2];
                }
            }
        }
        { // r member
            for (let m=0;m<rmember.length;m++) {
                let a=0;
                while (true) {
                    a = Math.floor(Math.random()*rseatn);
                    if (rseat[a][2]==3) break;
                }
                if (rmember[m][1].length>0) {
                    rseat[a] = [rmember[m][0],rmember[m][1],0];
                }
                else {
                    rseat[a] = [0,"名無し",2];
                }
            }
        }
        for (let m=0;m<fseatn;m++) {
            seat[fseatplace[m]-1] = 1
            seating[fseatplace[m]-1] = fseat[m]
        }
        for (let m=0;m<rseatn;m++) {
            seating[rseatplace[m]-1] = rseat[m]
        }
        return seating;
    }


    window.onload = function() {
        row = Number(document.getElementById("row").value);
        line = Number(document.getElementById("line").value);
        changetitle();
        makeseat();
        showprop();
    }

    function changetitle() {
        document.getElementById("title").innerHTML = document.getElementById("deftitle").value;
    }
    function changeseat() {
        row = Number(document.getElementById("row").value);
        line = Number(document.getElementById("line").value);
    }
    function getmember() {
        member = [];
        let table = document.getElementById("people");
        let cell = table.querySelectorAll("tr");
        for (let c=0;c<cell.length;c++) {
            let elm = cell[c].querySelectorAll("input")
            member.push([elm[0].value,elm[1].value,elm[2].checked]);
        }
        return member;
    }

    function makeseat() {
        showprop();
        let member = getmember();
        let seating = defseating();
        let seattag = 0;
        let table = document.createElement("table");
        table.className = "seat";
        table.id = "result";
        for (let rcnt=0;rcnt<row;rcnt++) {
            let tr = document.createElement("tr");
            tr.className = "seat";
            for (let lcnt=0;lcnt<line;lcnt++) {
                seattag++;
                        console.log(seat[rcnt*row+lcnt],"seat")
                if (seating[rcnt*row+lcnt][0]=="0") {
                    let td = document.createElement("td");
                    let tag = document.createElement("p");
                    tag.className = "nomargin tag empty";
                    tag.innerHTML = "0";
                    td.appendChild(tag);
                    let name = document.createElement("p");
                    name.className = "nomargin name empty";
                    name.innerHTML = seating[rcnt*row+lcnt][1];
                    td.appendChild(name);
                    td.className = "seat";
                    if (seat[rcnt*row+lcnt]==1) {
                        td.className = "seat frontseat";
                    }
                    tr.appendChild(td);
                }
                else {
                    let td = document.createElement("td");
                    let tag = document.createElement("p");
                    tag.className = "nomargin tag";
                    tag.innerHTML = seating[rcnt*row+lcnt][0].toString();
                    td.appendChild(tag);
                    let name = document.createElement("p");
                    name.className = "nomargin name";
                    name.innerHTML = seating[rcnt*row+lcnt][1];
                    td.appendChild(name);
                    td.className = "seat";
                    if (seat[rcnt*row+lcnt]==1) {
                        td.className = "seat frontseat";
                    }
                    tr.appendChild(td);
                }
            }
            table.appendChild(tr);
        }
        document.getElementById("result").replaceWith(table);
    }
</script>
<script>
    
let policy = `
目標
「公平で再現可能な席替え」
`
function showpolicy() {
    let carea = document.getElementById("contents")
    document.getElementById("policy").style.visibility = "visible"
    let scs = policy.split("\n")
    for (let i=0;i<scs.length;i++) {
        let pel = document.createElement("p")
        pel.innerHTML = scs[i]
        carea.appendChild(pel)
    }
}
function closepolicy() {
    document.getElementById("policy").style.visibility = "hidden"
    let carea = document.getElementById("contents")
    carea.innerHTML = ""
}
</script>
<style>
    @media print{
        .noPrint{display:none;}
        @page{size: auto;margin: 0;}
    }
    ul {
        list-style: none;
        padding: 2px;
    }

    div.control {
        background-color: rgba(173, 216, 230, 0.3);
        width: fit-content;
        padding: 50px;
        border-radius: 10px;
        z-index: 1;
        position: relative;
    }
    table.seat {
        margin: 10px;
        padding: 2px;
        width: 100%;
        height: 100%;
        table-layout: fixed;
    }
    div.rresize {
        border-radius: 5px;
        display: block;
        resize: both;
        overflow: hidden;
        width: 1000px;
        padding: 10px;
        min-height: max-content;
    }
    td.seat {
        margin: 0px;
        padding: 5px 20px 5px 20px;
        border: 1px solid gray;
        border-radius: 5px;
        background-color: blanchedalmond;
    }
    td.frontseat {
        background-color: beige;
    }
    p.nomargin {
        margin: 0px;
        padding: 0px;
    }
    p.tag {
        color: black;
        margin-left: -10px;
        margin-bottom: -5px;
        font-size: 20px;
        height: 25px;
    }
    p.name {
        color: black;
        font-size: 30px;
        text-align: center;
    }
    p.empty {
        color: rgb(158, 158, 158);
    }
    h1.title {
        width: fit-content;
        margin: 10px;
        border-radius: 10px;
        font-size: 50px;
        margin-top: 100px;
    }
    p.front {
        width: fit-content;
        background-color: antiquewhite;
        padding: 5px 50px 5px 50px;
        border-radius: 10px;
        margin: 0px;
        margin-bottom: -5px;
        margin-top: 50px;
    }
    div.rareaframe {
        position: absolute;
        top: 0px;
        width: 100%;
        right: 0px;
    }
    table#prop {
        padding: 5px;
        margin: 0px;
        border-radius: 2px;
        background-color: rgba(217, 250, 215, 0.6);
    }

    button {
        margin: 5px;
        padding: 5px;
    }

    #policy {
        border: 1px solid gray;
        border-radius: 10px;
        background-color: rgba(238, 255, 250, 0.9);
        position: fixed;
        top: 100px;
        left: 100px;
        padding: 20px;
        width: calc(100vw - 240px);
        height: calc(100vh - 240px);
        overflow: auto;
        box-shadow: 2px 2px 5px black;
    }

    #closepolicy {
        width: fit-content;
        display: block;
        margin: 0 0 0 auto;
    }
</style>