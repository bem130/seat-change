<!DOCTYPE html>
<html moznomarginboxes mozdisallowselectionprint>
    <head>
        <title>Seat Change</title>
        <meta charset="utf-8">
        <meta name="description" content="席替えソフト">
    </head>
    <body>
        <div class="noPrint control">
            <div>
                <h1>席替え</h1>
            </div>
            <div>
                <button onclick="showpolicy()">方針</button>
            </div>
            <div>
                <table id="prop">
                    <tr>
                        <td>席の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>人の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>前列席の数</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>前列希望の人の数</td>
                        <td>0</td>
                    </tr>
                </table>
            </div>
            <progress id="step" max="5" value="1"></progress>
            <div id="step1">
                <p>タイトルを定義</p>
                <input id="deftitle" type="text" onchange="changetitle()" onkeyup="changetitle()" value="○月の席">
            </div>
            <div id="step2">
                <p>席の定義</p>
                <table>
                    <tr>
                        <td>行</td>
                        <td><input id="line" type="number" onchange="changeseat()" value="6"></td>
                    </tr>
                    <tr>
                        <td>列</td>
                        <td><input id="row" type="number" onchange="changeseat()" value="6"></td>
                    </tr>
                </table>
                <p>席をクリックで 通常の席 , 前の席 , 席無し に変更できます</p>
                <ul>
                    <li><button onclick="stype=1">通常の席を選択</button></li>
                    <li><button onclick="stype=2">前の席を選択</button></li>
                    <li><button onclick="stype=3">席が無いところを選択</button></li>
                    <li><button onclick="stype=-1">未指定に戻すところを選択</button></li>
                </ul>
            </div>
            <div id="step3">
                <p>人を追加</p>
                <button onclick="addperson()">欄を追加</button>
                <table>
                    <thead>
                        <tr>
                            <td>出席番号</td>
                            <td>名前</td>
                            <td>前列</td>
                            <td>削除</td>
                        </tr>
                    </thead>
                    <tbody id="people">
                    </tbody>
                </table>
            </div>
            <div id="step4">
                <button onclick="makeseat()">生成</button>
            </div>
            <div id="step5">
                <button onclick="print()">print</button>
            </div>
            <div id="policy" style="visibility: hidden;">
                <button onclick="closepolicy()" id="closepolicy">閉じる</button>
                <div id="contents"></div>
            </div>
        </div>
        <center>
            <div class="rareaframe">
                <div class="rarea">
                    <h1 class="title" id="title"></h1>
                    <p class="front">前</p>
                    <div class="rresize">
                        <table id="result"></table>
                    </div>
                </div>
            </div>
        </center>
    </body>
</html>
<script>
    var pcnt=0;
    var member = [];
    var line,row;
    var fseatplace = []
    var rseatplace = []
    var nseatplace = []
    var fmember = []
    var rmember = []
    var stype = 0

    function changesprop(id) {
        id = Number(id)+1
        console.log(id)
        if (stype==-1) {
            rseatplace = rseatplace.filter(itm=>itm!=id);
            fseatplace = fseatplace.filter(itm=>itm!=id);
            nseatplace = nseatplace.filter(itm=>itm!=id);
        }
        if (stype==1) {
            if (!rseatplace.includes(id)) {
                rseatplace.push(id)
            }
            fseatplace = fseatplace.filter(itm=>itm!=id);
            nseatplace = nseatplace.filter(itm=>itm!=id);
        }
        if (stype==2) {
            if (!fseatplace.includes(id)) {
                fseatplace.push(id)
            }
            rseatplace = rseatplace.filter(itm=>itm!=id);
            nseatplace = nseatplace.filter(itm=>itm!=id);
        }
        if (stype==3) {
            if (!nseatplace.includes(id)) {
                nseatplace.push(id)
            }
            fseatplace = fseatplace.filter(itm=>itm!=id);
            rseatplace = rseatplace.filter(itm=>itm!=id);
        }
    }

    function addperson() {
        pcnt++;
        let tr = document.createElement("tr")
        let td1 = document.createElement("td");
        let iid = document.createElement("input");
        iid.type = "number";
        iid.placeholder = "number";
        iid.value = pcnt.toString();
        td1.appendChild(iid);
        tr.appendChild(td1);
        let td2 = document.createElement("td");
        let iarea = document.createElement("input");
        iarea.type = "text";
        iarea.placeholder = "name";
        td2.appendChild(iarea);
        tr.appendChild(td2);
        let td3 = document.createElement("td");
        let check = document.createElement("input");
        check.type = "checkbox";
        check.onchange = function() {showprop();};
        td3.appendChild(check);
        tr.appendChild(td3);
        let td4 = document.createElement("td");
        let del = document.createElement("input");
        del.onclick = function(e){e.explicitOriginalTarget.parentNode.parentNode.remove();showprop();};
        del.type = "button";
        del.value = "x"
        td4.appendChild(del);
        tr.appendChild(td4);
        document.getElementById("people").appendChild(tr);
        showprop();
    }

    function showprop() {
        prop = document.getElementById("prop").querySelectorAll("td")
        let table = document.getElementById("result").querySelectorAll("td");
        let people = document.getElementById("people").querySelectorAll("tr");
        let front = 0;
        let fronts = 0
        prop[1].innerHTML = row*line;
        prop[3].innerHTML = people.length;
        prop[5].innerHTML = fronts;
        prop[7].innerHTML = front;
    }

    
    function defseating() {
        let fseatn = fmember.length
        let rseatn = rmember.length
        let otseatn = 5
        fseat = Array(fseatn).fill([0,"空席",3])
        rseat = Array(rseatn).fill([0,"空席",3])
        if ((fseatplace.length<fseatn||rseatplace.length<rseatn)&&(fseatn>0||rseatn>0)) {
            throw("席が足りません")
        }
        let seating = Array(row*line).fill([0,"空席",3]);
        { // f member
            for (let m=0;m<fmember.length;m++) {
                let a=0;
                while (true) {
                    a = Math.floor(Math.random()*fseatn);
                    if (fseat[a][2]==3) break;
                }
                if (fmember[m][1].length>0) {
                    fseat[a] = [fmember[m][0],fmember[m][1],1];
                }
                else {
                    fseat[a] = [0,"名無し",2];
                }
            }
        }
        { // r member
            for (let m=0;m<rmember.length;m++) {
                let a=0;
                while (true) {
                    a = Math.floor(Math.random()*rseatn);
                    if (rseat[a][2]==3) break;
                }
                if (rmember[m][1].length>0) {
                    rseat[a] = [rmember[m][0],rmember[m][1],0];
                }
                else {
                    rseat[a] = [0,"名無し",2];
                }
            }
        }
        for (let m=0;m<nseatplace.length;m++) {
            seating[nseatplace[m]-1] = [0,"席無し",4]
        }
        for (let m=0;m<fseatn;m++) {
            seating[fseatplace[m]-1] = fseat[m]
        }
        for (let m=0;m<rseatn;m++) {
            seating[rseatplace[m]-1] = rseat[m]
        }
        return seating;
    }


    window.onload = function() {
        row = Number(document.getElementById("row").value);
        line = Number(document.getElementById("line").value);
        changetitle();
        makeseat();
        showprop();
    }

    function changetitle() {
        document.getElementById("title").innerHTML = document.getElementById("deftitle").value;
    }
    function changeseat() {
        row = Number(document.getElementById("row").value);
        line = Number(document.getElementById("line").value);
    }
    function getmember() {
        fmember = []
        rmember = []
        let table = document.getElementById("people");
        let cell = table.querySelectorAll("tr");
        for (let c=0;c<cell.length;c++) {
            let elm = cell[c].querySelectorAll("input")
            if (elm[2].checked) {
                fmember.push([elm[0].value,elm[1].value]);
            }
            else {
                rmember.push([elm[0].value,elm[1].value]);
            }
        }
    }

    function makeseat() {
        showprop();
        getmember();
        let seating = defseating();
        let seattag = 0;
        let table = document.createElement("table");
        table.className = "seat";
        table.id = "result";
        for (let rcnt=0;rcnt<row;rcnt++) {
            let tr = document.createElement("tr");
            tr.className = "seat";
            for (let lcnt=0;lcnt<line;lcnt++) {
                seattag++;
                       // console.log(seating[rcnt*(row+1)+lcnt],"seat")
                let td = document.createElement("td");
                let tag = document.createElement("p");
                {
                    tag.className = "nomargin tag nopoint";
                    tag.innerHTML = seating[rcnt*(row+1)+lcnt][0].toString();
                    td.appendChild(tag);
                    let name = document.createElement("p");
                    name.className = "nomargin name nopoint";
                    name.innerHTML = seating[rcnt*(row+1)+lcnt][1];
                    td.appendChild(name);
                    td.className = "seat";
                    if (seating[rcnt*(row+1)+lcnt][2]==1) {
                        td.className = "seat frontseat";
                    }
                    if (seating[rcnt*(row+1)+lcnt][2]==3) {
                        tag.className += " empty";
                        name.className += " empty";
                    }
                    if (seating[rcnt*(row+1)+lcnt][2]==4) {
                        td.className += " noseat";
                        tag.className += " noseat";
                        name.className += " noseat";
                    }
                }
                td.dataset.seatid = (rcnt*(row+1)+lcnt).toString();
                td.onclick = function(e){changesprop(e.explicitOriginalTarget.dataset.seatid)};
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        document.getElementById("result").replaceWith(table);
    }
</script>
<script>
    
let policy = `
目標
「公平で再現可能な席替え」
`
function showpolicy() {
    let carea = document.getElementById("contents")
    document.getElementById("policy").style.visibility = "visible"
    let scs = policy.split("\n")
    for (let i=0;i<scs.length;i++) {
        let pel = document.createElement("p")
        pel.innerHTML = scs[i]
        carea.appendChild(pel)
    }
}
function closepolicy() {
    document.getElementById("policy").style.visibility = "hidden"
    let carea = document.getElementById("contents")
    carea.innerHTML = ""
}
</script>
<style>
    @media print{
        .noPrint{display:none;}
        @page{size: auto;margin: 0;}
    }
    ul {
        list-style: none;
        padding: 2px;
    }

    div.control {
        background-color: rgba(173, 216, 230, 0.3);
        width: fit-content;
        padding: 50px;
        border-radius: 10px;
        z-index: 1;
        position: relative;
    }
    table.seat {
        margin: 10px;
        padding: 2px;
        width: 100%;
        height: 100%;
        table-layout: fixed;
    }

    div.rresize {
        border-radius: 5px;
        display: block;
        resize: both;
        overflow: hidden;
        width: 1000px;
        padding: 10px;
        min-height: max-content;
    }
    td.seat {
        margin: 0px;
        padding: 5px 20px 5px 20px;
        border: 1px solid gray;
        border-radius: 5px;
        background-color: blanchedalmond;
    }
    td.seat:hover {
        padding: 2px 22px 8px 18px;
        border: 1px solid rgb(56, 53, 44);
    }
    td.seat.noseat {
        border: 1px solid rgba(255, 255, 255, 0);
        background-color: rgba(255, 235, 205, 0.079);
    }
    td.seat.noseat:hover {
        padding: 2px 22px 8px 18px;
        border: 1px solid rgb(174, 170, 158);
    }

    td.frontseat {
        background-color: beige;
    }
    p.nomargin {
        margin: 0px;
        padding: 0px;
    }
    p.tag {
        color: black;
        margin-left: -10px;
        margin-bottom: -5px;
        font-size: 20px;
        height: 25px;
    }
    p.name {
        color: black;
        font-size: 30px;
        text-align: center;
    }
    p.empty {
        color: rgb(158, 158, 158);
    }
    p.noseat {
        color: rgba(255, 255, 255, 0);
    }
    h1.title {
        width: fit-content;
        margin: 10px;
        border-radius: 10px;
        font-size: 50px;
        margin-top: 100px;
    }
    p.front {
        width: fit-content;
        background-color: antiquewhite;
        padding: 5px 50px 5px 50px;
        border-radius: 10px;
        margin: 0px;
        margin-bottom: -5px;
        margin-top: 50px;
    }
    div.rareaframe {
        position: absolute;
        top: 0px;
        width: 100%;
        right: 0px;
    }
    table#prop {
        padding: 5px;
        margin: 0px;
        border-radius: 2px;
        background-color: rgba(217, 250, 215, 0.6);
    }

    .nopoint {
        pointer-events: none;
    }

    button {
        margin: 5px;
        padding: 5px;
    }

    #policy {
        border: 1px solid gray;
        border-radius: 10px;
        background-color: rgba(238, 255, 250, 0.9);
        position: fixed;
        top: 100px;
        left: 100px;
        padding: 20px;
        width: calc(100vw - 240px);
        height: calc(100vh - 240px);
        overflow: auto;
        box-shadow: 2px 2px 5px black;
    }

    #closepolicy {
        width: fit-content;
        display: block;
        margin: 0 0 0 auto;
    }
</style>