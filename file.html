<!DOCTYPE html>
<html moznomarginboxes mozdisallowselectionprint>
    <head>
        <title>Seat Change</title>
        <meta charset="utf-8">
        <meta name="description" content="席替えソフト">
    </head>
    <body>
        <div class="noPrint control">
            <div>
                <h1>席替え</h1>
            </div>
            <div>
                <button onclick="showpolicy()">方針</button>
            </div>
            <div id="step1">
                <button onclick="">読み込み</button>
            </div>
            <div id="step2">
                <button onclick="makeseat()">生成</button>
            </div>
            <div id="step3">
                <button onclick="print()">print</button>
            </div>
            <div id="policy" style="visibility: hidden;">
                <button onclick="closepolicy()" id="closepolicy">閉じる</button>
                <div id="contents"></div>
            </div>
        </div>
        <center>
            <div class="rareaframe">
                <div class="rarea">
                    <h1 class="title" id="title"></h1>
                    <p class="front">前</p>
                    <div class="rresize">
                        <table id="result"></table>
                    </div>
                </div>
            </div>
        </center>
    </body>
</html>
<script>

random = Math.random; // 乱数の生成に用いる関数

function localfile() {
    ifelm = document.createElement("input");
    ifelm.type = "file";
    ifelm.onchange = function (input) {
        let reader = new FileReader();
        reader.onload = function () {
            loadfile(reader.result);
        }
        reader.readAsText(input.target.files[0]);
    };
    ifelm.click();
}
async function serverfile() {
    let res = await fetch(`./sample/draft.txt`, {method: "GET"});
    let data = await res.text();
    loadfile(data);
}

serverfile();

function loadfile(text) {
    let retdatas = {};
    let data = text.split("\r\n");
    let ncdata = [];
    for (let i=0;i<data.length;i++) {
        if (data[i][0]!=";") {
            ncdata.push(data[i]);
        }
    }
    let blocks = {
        "nsc": [],
        "template": [],
        "seat": [],
        "member": [],
    }
    let blocksconf = {
        "nsc": "",
        "template": "",
        "seat": "",
        "member": "",
    }
    let blocksname = Object.keys(blocks);
    let nblock = "";
    let nblockconf = "";
    for (let i=0;i<ncdata.length;i++) {
        if (ncdata[i][0]=="!") {
            let tblock = ncdata[i].slice(1).split(" ");
            nblock = tblock[0];
            nblockconf = tblock[1];
            if (nblockconf!=null&&nblockconf.length>0&&blocksname.indexOf(nblock)!=-1) {
                blocksconf[nblock] = nblockconf;
            }
            continue;
        }
        if (blocksname.indexOf(nblock)!=-1) {
            blocks[nblock].push(ncdata[i]);
        }
    }
    {// template
        let bdata = {
            "title": "",
        }
        let bdatasname = Object.keys(bdata);
        for (let i=0;i<blocks.template.length;i++) {
            let bdatas = (blocks.template[i]).split(",");
            if (bdatasname.indexOf(bdatas[0])!=-1) {
                bdata[bdatas[0]] = bdatas[1];
            }
        }
        retdatas.title = bdata.title;
    }
    {// seat
        let seatarg = [0,0];
        let tseatarg = blocksconf.seat.split("x");
        let frontseat = 0
        let rearseat = 0
        seatarg[0] = Math.floor(Number(tseatarg[0]));
        seatarg[1] = Math.floor(Number(tseatarg[1]));
        let seatarray = new Uint8ClampedArray(seatarg[0]*seatarg[1]);
        if (seatarg[1]!=blocks.seat.length) {
            console.error("defined size doesn't match");
            return false;
        }
        for (let i=0;i<blocks.seat.length;i++) {
            let bdatas = blocks.seat[i];
            if (seatarg[0]!=bdatas.length) {
                console.error("defined size doesn't match");
                return false;
            }
            for (let x=0;x<seatarg[0];x++) {
                let ii = i*seatarg[0]+x;
                let tseat = Number(bdatas[x]);
                switch (tseat) {
                    case 0:
                        rearseat++;
                        seatarray[ii] = 0;
                        break;
                    case 1:
                        frontseat++;
                        seatarray[ii] = 1;
                        break;
                    case 2:
                        seatarray[ii] = 2;
                        break;
                    case 3:
                        seatarray[ii] = 3;
                        break;
                    default:
                        console.error(`not defined seat ${bdatas[x]}`)
                        break;
                }
            }
        }
        retdatas.frontseat = frontseat;
        retdatas.rearseat = rearseat;
        retdatas.seatarg = seatarg;
        retdatas.seatarray = seatarray;
    }
    {// member
        let conf = blocksconf.member.split(",");
        if (conf.indexOf("front")==-1) {
            console.error("front member aren't defined");
            return false;
        }
        let frontmember = [];
        let rearmember = [];
        for (let i=0;i<blocks.member.length;i++) {
            let pdata = blocks.member[i].split(",");
            let frontflag = Number(pdata[conf.indexOf("front")]);
            if (frontflag==0) {
                rearmember.push([pdata[0],pdata[1]]);
            }
            else if (frontflag==1) {
                frontmember.push([pdata[0],pdata[1]]);
            }
        }
        retdatas.front = frontmember;
        retdatas.rear = rearmember;
    }
    console.log(retdatas);
    makeseating(retdatas);
}

function makeseating(data) {
    if (data.frontseat<data.front.length) {
        console.error("not enough front seats");
        return false;
    }
    if (data.rearseat<data.rear.length) {
        console.error("not enough rear seats");
        return false;
    }
    let seating = Array(data.seatarg[0]*data.seatarg[1]);
    for (let i=0;i<seating.length;i++) {
        seating[i] = ["Null","空席",data.seatarray[i]]
    }
    let frontadrs = []
    let rearadrs = []
    for (let i=0;i<data.seatarray.length;i++) {
        if (data.seatarray[i]==1) {
            frontadrs.push(i);
        }
        else if (data.seatarray[i]==0) {
            rearadrs.push(i);
        }
    }
    for (let p=0;p<data.front.length;p++) { // front seats
        console.log(data.front[p])
        while (true) {
            let aadr = Math.floor(random()*frontadrs.length);
            if (frontadrs[aadr]!=-1) {
                seating[frontadrs[aadr]][0] = data.front[p][0];
                seating[frontadrs[aadr]][1] = data.front[p][1];
                frontadrs[aadr] = -1;
                break;
            }
        }
    }
    for (let p=0;p<data.rear.length;p++) { // rear seats
        console.log(data.rear[p])
        while (true) {
            let aadr = Math.floor(random()*rearadrs.length);
            if (rearadrs[aadr]!=-1) {
                seating[rearadrs[aadr]][0] = data.rear[p][0];
                seating[rearadrs[aadr]][1] = data.rear[p][1];
                rearadrs[aadr] = -1;
                break;
            }
        }
    }
    console.log(frontadrs,rearadrs);
    console.log(seating);
    showresult(seating,data);
}


function showresult(seating,data) {
    let seattag = 0;
    let table = document.createElement("table");
    table.className = "seat";
    table.id = "result";
    for (let rcnt=0;rcnt<data.seatarg[1];rcnt++) {
        let tr = document.createElement("tr");
        tr.className = "seat";
        for (let lcnt=0;lcnt<data.seatarg[0];lcnt++) {
            let tseat = seating[rcnt*data.seatarg[0]+lcnt];
            seattag++;
            let td = document.createElement("td");
            let tag = document.createElement("p");
            {
                tag.className = "nomargin tag nopoint";
                tag.innerHTML = tseat[0].toString();
                td.appendChild(tag);
                let name = document.createElement("p");
                name.className = "nomargin name nopoint";
                name.innerHTML = tseat[1];
                td.appendChild(name);
                td.className = "seat";
                if (seating[rcnt*(data.seatarg[0])+lcnt][2]==1) {
                    td.className = "seat frontseat";
                }
                if (seating[rcnt*(data.seatarg[0])+lcnt][2]==2) {
                    tag.className += " empty";
                    name.className += " empty";
                }
                if (seating[rcnt*(data.seatarg[0])+lcnt][2]==3) {
                    td.className += " noseat";
                    tag.className += " noseat";
                    name.className += " noseat";
                }
            }
            td.dataset.seatid = (rcnt*(data.seatarg[0]+1)+lcnt).toString();
            tr.appendChild(td);
        }
        table.appendChild(tr);
    }
    document.getElementById("title").innerText = data.title;
    document.getElementById("result").replaceWith(table);
}

</script>
<script>
    
let policy = `
目標
「公平かつ簡単な席替え」
席替えはできる限り公平でなくてはならない
しかし、公平にするためだとしても、面倒になるのはよくない

疑似乱数を用いて、非常にランダム かつ 検証もしやすい 席替えを目指しました
`
function showpolicy() {
    let carea = document.getElementById("contents")
    document.getElementById("policy").style.visibility = "visible"
    let scs = policy.split("\n")
    for (let i=0;i<scs.length;i++) {
        let pel = document.createElement("p")
        pel.innerHTML = scs[i]
        carea.appendChild(pel)
    }
}
function closepolicy() {
    document.getElementById("policy").style.visibility = "hidden"
    let carea = document.getElementById("contents")
    carea.innerHTML = ""
}
</script>
<style>
    @media print{
        .noPrint{display:none;}
        @page{size: auto;margin: 0;}
    }
    ul {
        list-style: none;
        padding: 2px;
    }

    div.control {
        background-color: rgba(173, 216, 230, 0.3);
        width: fit-content;
        padding: 50px;
        border-radius: 10px;
        z-index: 1;
        position: relative;
    }
    table.seat {
        margin: 10px;
        padding: 2px;
        width: 100%;
        height: 100%;
        table-layout: fixed;
    }

    div.rresize {
        border-radius: 5px;
        display: block;
        resize: both;
        overflow: hidden;
        width: 1000px;
        padding: 10px;
        min-height: max-content;
    }
    td.seat {
        margin: 0px;
        padding: 5px 20px 5px 20px;
        border: 1px solid gray;
        border-radius: 5px;
        background-color: blanchedalmond;
    }
    td.seat.noseat {
        border: 1px solid rgba(255, 255, 255, 0);
        background-color: rgba(255, 235, 205, 0.079);
    }

    td.frontseat {
        background-color: beige;
    }
    p.nomargin {
        margin: 0px;
        padding: 0px;
    }
    p.tag {
        color: black;
        margin-left: -10px;
        margin-bottom: -5px;
        font-size: 20px;
        height: 25px;
    }
    p.name {
        color: black;
        font-size: 30px;
        text-align: center;
    }
    p.empty {
        color: rgb(158, 158, 158);
    }
    p.noseat {
        color: rgba(255, 255, 255, 0);
    }
    p.tag.noseat,empty {
        visibility: hidden;
    }
    h1.title {
        width: fit-content;
        margin: 10px;
        border-radius: 10px;
        font-size: 50px;
        margin-top: 100px;
    }
    p.front {
        width: fit-content;
        background-color: antiquewhite;
        padding: 5px 50px 5px 50px;
        border-radius: 10px;
        margin: 0px;
        margin-bottom: -5px;
        margin-top: 50px;
    }
    div.rareaframe {
        position: absolute;
        top: 0px;
        width: 100%;
        right: 0px;
    }
    table#prop {
        padding: 5px;
        margin: 0px;
        border-radius: 2px;
        background-color: rgba(217, 250, 215, 0.6);
    }

    .nopoint {
        pointer-events: none;
    }

    button {
        margin: 5px;
        padding: 5px;
    }

    #policy {
        border: 1px solid gray;
        border-radius: 10px;
        background-color: rgba(238, 255, 250, 0.9);
        position: fixed;
        top: 100px;
        left: 100px;
        padding: 20px;
        width: calc(100vw - 240px);
        height: calc(100vh - 240px);
        overflow: auto;
        box-shadow: 2px 2px 5px black;
    }

    #closepolicy {
        width: fit-content;
        display: block;
        margin: 0 0 0 auto;
    }
</style>